<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CricLive - Game Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Top Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">CricLive</a>
            <div class="navbar-nav ms-auto" id="nav-links">
                <a class="nav-link" href="/">View Scorecard</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Current Score Section -->
        <div class="control-section">
            <h3>Current Score</h3>
            <div class="row">
                <div class="col-md-3">
                    <strong>Innings:</strong> <span id="control-innings-type">1st Innings</span>
                </div>
                <div class="col-md-3">
                    <strong>Score:</strong> <span id="control-score">0/0</span>
                </div>
                <div class="col-md-3">
                    <strong>Overs:</strong> <span id="control-overs">0.0 / 20</span>
                </div>
                <div class="col-md-3">
                    <strong>Run Rate:</strong> <span id="control-run-rate">0.00</span>
                </div>
            </div>
            <div class="row mt-2" id="control-target" style="display: none;">
                <div class="col-md-6">
                    <span class="target-score" id="control-target"></span>
                </div>
                <div class="col-md-6">
                    <strong>Required Run Rate:</strong> <span id="control-required-run-rate"></span>
                </div>
            </div>
        </div>

        <!-- Batting Side Section -->
        <div class="control-section">
            <h3>Batting Side</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card striker-highlight">
                        <div class="card-header bg-warning">
                            <strong>Striker</strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-0" id="control-striker">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <strong>Non-Striker</strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-0" id="control-non-striker">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bowling Side Section -->
        <div class="control-section">
            <h3>Bowling Side</h3>
            <div class="mb-3">
                <label for="bowler-select" class="form-label">Select Current Bowler</label>
                <select class="form-select" id="bowler-select">
                    <option value="">Select Bowler</option>
                </select>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <strong>Bowler:</strong> <span id="control-bowler">-</span>
                </div>
                <div class="col-md-6">
                    <strong>Stats:</strong> <span id="control-bowler-stats">-</span>
                </div>
            </div>
            <div class="mt-2">
                <strong>Ball-by-Ball Status:</strong>
                <div id="ball-by-ball-status" class="mt-2"></div>
            </div>
        </div>

        <!-- Ball-by-Ball Action Board -->
        <div class="ball-action-board">
            <h3>Ball-by-Ball Action</h3>
            
            <!-- Score Buttons -->
            <div class="mb-3">
                <label class="form-label">Runs Scored</label>
                <div>
                    <button type="button" class="btn btn-primary score-btn" id="score-0">0</button>
                    <button type="button" class="btn btn-primary score-btn" id="score-1">1</button>
                    <button type="button" class="btn btn-primary score-btn" id="score-2">2</button>
                    <button type="button" class="btn btn-primary score-btn" id="score-3">3</button>
                    <button type="button" class="btn btn-primary score-btn" id="score-4">4</button>
                    <button type="button" class="btn btn-primary score-btn" id="score-5">5</button>
                    <button type="button" class="btn btn-primary score-btn" id="score-6">6</button>
                </div>
            </div>

            <!-- Ball Status -->
            <div class="mb-3">
                <label for="ball-type" class="form-label">Ball Status</label>
                <select class="form-select" id="ball-type">
                    <option value="normal">Normal</option>
                    <option value="wide">Wide</option>
                    <option value="no-ball">No Ball</option>
                    <option value="dead-ball">Dead Ball</option>
                </select>
            </div>

            <!-- Free Hit -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="free-hit">
                    <label class="form-check-label" for="free-hit">
                        Free Hit
                    </label>
                </div>
            </div>

            <!-- Wicket Button -->
            <div class="mb-3">
                <button type="button" class="btn btn-danger btn-lg" id="wicket-btn">Wicket</button>
            </div>
        </div>

        <!-- Innings Control -->
        <div class="control-section">
            <h3>Innings Control</h3>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-warning btn-lg" id="end-innings-btn">End Innings</button>
                <button type="button" class="btn btn-danger btn-lg" id="end-match-btn">End Match</button>
            </div>
        </div>
    </div>

    <!-- Wicket Modal -->
    <div class="modal fade" id="wicket-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record Wicket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="wicket-form">
                        <div class="mb-3">
                            <label for="dismissal-type" class="form-label">Dismissal Type</label>
                            <select class="form-select" id="dismissal-type" required>
                                <option value="">Select Type</option>
                                <option value="bowled">Bowled</option>
                                <option value="catch">Catch</option>
                                <option value="stump-out">Stumped</option>
                                <option value="run-out">Run Out</option>
                                <option value="hit-wicket">Hit Wicket</option>
                                <option value="LBW">LBW</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3" id="fielder-group" style="display: none;">
                            <label for="fielder-select" class="form-label">Fielder</label>
                            <select class="form-select" id="fielder-select">
                                <option value="">Select Fielder</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Record Wicket</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getActiveMatch } from './js/api.js';
        import { startPolling, stopPolling } from './js/scoreboard.js';
        import { initializeControl, setBowler, setUpdateBowlerSelectCallback, getCurrentBowler } from './js/control.js';
        import { requireAuth, isAuthenticated } from './js/auth.js';
        
        // Make currentBowler accessible in this scope
        let currentBowler = null;

        // Check authentication
        if (!requireAuth()) {
            window.location.href = '/login.html';
        }

        // Update navigation links
        const navLinks = document.getElementById('nav-links');
        if (isAuthenticated()) {
            // Create Management link
            const managementLink = document.createElement('a');
            managementLink.className = 'nav-link';
            managementLink.href = '/lineup.html';
            managementLink.textContent = 'Management';
            
            // Create Logout link
            const logoutLink = document.createElement('a');
            logoutLink.className = 'nav-link';
            logoutLink.href = '#';
            logoutLink.textContent = 'Logout';
            logoutLink.onclick = (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/';
                }
            };
            
            // Insert Management and Logout links (Management before Logout)
            navLinks.appendChild(managementLink);
            navLinks.appendChild(logoutLink);
        }

        let currentMatch = null;

        async function loadMatch() {
            try {
                const match = await getActiveMatch();
                if (match) {
                    // Debug: Log match data to console
                    console.log('Match loaded:', match);
                    console.log('Team A players:', match.teamA?.players);
                    console.log('Team B players:', match.teamB?.players);
                    console.log('First innings:', match.firstInnings);
                    console.log('Batting first:', match.battingFirst);
                    
                    currentMatch = match;
                    initializeControl(match);
                    updateBowlerSelect(match);
                    
                    // Start polling for updates
                    startPolling((updatedMatch) => {
                        if (updatedMatch) {
                            currentMatch = updatedMatch;
                            initializeControl(updatedMatch);
                        }
                    }, 2000);
                } else {
                    alert('No active match found. Please create a match first.');
                    window.location.href = '/lineup.html';
                }
            } catch (error) {
                console.error('Error loading match:', error);
                if (error.message && error.message.includes('404')) {
                    alert('No active match found. Please create a match first.');
                    window.location.href = '/lineup.html';
                } else {
                    alert('Error loading match. Please try again.');
                }
            }
        }

        function updateBowlerSelect(match) {
            const bowlerSelect = document.getElementById('bowler-select');
            const fielderSelect = document.getElementById('fielder-select');
            if (!bowlerSelect) return;

            const currentInnings = match.currentInnings === 1 ? match.firstInnings : match.secondInnings;
            
            // Determine bowling team based on battingFirst field
            // Default to teamA if battingFirst is not set
            const battingFirst = match.battingFirst || 'teamA';
            let bowlingTeam;
            if (match.currentInnings === 1) {
                // First innings: if teamA is batting first, teamB bowls; otherwise teamA bowls
                bowlingTeam = battingFirst === 'teamA' ? match.teamB : match.teamA;
            } else {
                // Second innings: opposite of first innings
                bowlingTeam = battingFirst === 'teamA' ? match.teamA : match.teamB;
            }

            // Debug logging
            console.log('Bowling team:', bowlingTeam);
            console.log('Bowling team players:', bowlingTeam?.players);
            console.log('Current innings bowling card:', currentInnings?.bowlingCard);

            // Populate bowler select
            bowlerSelect.innerHTML = '<option value="">Select Bowler</option>';
            
            // Try to get player names from bowling card first (they're populated)
            const playerMap = new Map();
            if (currentInnings && currentInnings.bowlingCard) {
                currentInnings.bowlingCard.forEach(card => {
                    if (card.player) {
                        const playerId = card.player._id ? card.player._id.toString() : card.player.toString();
                        const playerName = card.player.name || 'Player';
                        playerMap.set(playerId, playerName);
                    }
                });
            }
            
            // Populate from team players if available, otherwise use bowling card
            if (bowlingTeam && bowlingTeam.players && bowlingTeam.players.length > 0) {
                bowlingTeam.players.forEach(player => {
                    const option = document.createElement('option');
                    let playerId, playerName;
                    
                    if (typeof player === 'object' && player._id) {
                        playerId = player._id.toString();
                        playerName = player.name || playerMap.get(playerId) || 'Player';
                    } else {
                        playerId = player.toString();
                        playerName = playerMap.get(playerId) || 'Player';
                    }
                    
                    option.value = playerId;
                    option.textContent = playerName;
                    bowlerSelect.appendChild(option);
                });
            } else if (playerMap.size > 0) {
                // Fallback: use players from bowling card if team players not available
                playerMap.forEach((name, id) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    bowlerSelect.appendChild(option);
                });
            }

            // Populate fielder select (same logic as bowler select)
            if (fielderSelect) {
                fielderSelect.innerHTML = '<option value="">Select Fielder</option>';
                
                if (bowlingTeam && bowlingTeam.players && bowlingTeam.players.length > 0) {
                    bowlingTeam.players.forEach(player => {
                        const option = document.createElement('option');
                        let playerId, playerName;
                        
                        if (typeof player === 'object' && player._id) {
                            playerId = player._id.toString();
                            playerName = player.name || playerMap.get(playerId) || 'Player';
                        } else {
                            playerId = player.toString();
                            playerName = playerMap.get(playerId) || 'Player';
                        }
                        
                        option.value = playerId;
                        option.textContent = playerName;
                        fielderSelect.appendChild(option);
                    });
                } else if (playerMap.size > 0) {
                    // Fallback: use players from bowling card
                    playerMap.forEach((name, id) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        fielderSelect.appendChild(option);
                    });
                }
            }

            // Set current bowler if available (from innings or from previous selection)
            if (currentInnings.currentBowler) {
                const bowlerId = typeof currentInnings.currentBowler === 'object' 
                    ? currentInnings.currentBowler._id.toString()
                    : currentInnings.currentBowler.toString();
                bowlerSelect.value = bowlerId;
                setBowler(bowlerId);
            } else if (currentBowler) {
                // Keep current bowler if over is not complete
                const validBalls = currentInnings.balls.filter(b => 
                    b.ballType !== 'wide' && b.ballType !== 'no-ball' && b.ballType !== 'dead-ball'
                );
                const isOverComplete = validBalls.length % 6 === 0 && validBalls.length > 0;
                
                if (!isOverComplete) {
                    // Check if current bowler has balls in current over
                    const currentOverBalls = validBalls.slice(-6);
                    const bowlerBallsInOver = currentOverBalls.filter(b => 
                        b.bowler && b.bowler.toString() === currentBowler.toString()
                    ).length;
                    
                    if (bowlerBallsInOver > 0 && bowlerBallsInOver < 6) {
                        // Keep the bowler selected
                        bowlerSelect.value = currentBowler;
                    }
                }
            }

            // Remove existing listener and add new one
            const newBowlerSelect = bowlerSelect.cloneNode(true);
            bowlerSelect.parentNode.replaceChild(newBowlerSelect, bowlerSelect);
            newBowlerSelect.addEventListener('change', (e) => {
                const selectedBowler = e.target.value;
                if (selectedBowler) {
                    // Check if over is complete before allowing bowler change
                    const currentInnings = match.currentInnings === 1 ? match.firstInnings : match.secondInnings;
                    const validBalls = currentInnings.balls.filter(b => 
                        b.ballType !== 'wide' && b.ballType !== 'no-ball' && b.ballType !== 'dead-ball'
                    );
                    const isOverComplete = validBalls.length % 6 === 0 && validBalls.length > 0;
                    
                    // Get current bowler from control.js
                    const currentBowlerValue = getCurrentBowler();
                    
                    // If there's a current bowler and over is not complete, prevent change
                    if (currentBowlerValue && !isOverComplete && validBalls.length > 0) {
                        const currentOverBalls = validBalls.slice(-6);
                        const bowlerBallsInOver = currentOverBalls.filter(b => 
                            b.bowler && b.bowler.toString() === currentBowlerValue.toString()
                        ).length;
                        
                        if (bowlerBallsInOver < 6 && bowlerBallsInOver > 0) {
                            alert(`Cannot change bowler. Current bowler has bowled ${bowlerBallsInOver} balls in this over. Please complete the over (6 balls) before changing bowler.`);
                            e.target.value = currentBowlerValue;
                            return;
                        }
                    }
                    
                    setBowler(selectedBowler);
                    currentBowler = selectedBowler; // Update local variable
                } else {
                    // Only allow clearing if over is complete
                    const currentInnings = match.currentInnings === 1 ? match.firstInnings : match.secondInnings;
                    const validBalls = currentInnings.balls.filter(b => 
                        b.ballType !== 'wide' && b.ballType !== 'no-ball' && b.ballType !== 'dead-ball'
                    );
                    const isOverComplete = validBalls.length % 6 === 0 && validBalls.length > 0;
                    
                    const currentBowlerValue = getCurrentBowler();
                    if (currentBowlerValue && !isOverComplete) {
                        alert('Cannot clear bowler selection. Please complete the over (6 balls) first.');
                        e.target.value = currentBowlerValue;
                        return;
                    }
                    
                    setBowler(null);
                    currentBowler = null; // Update local variable
                }
            });
        }

        // Set callback for updating bowler select
        setUpdateBowlerSelectCallback(updateBowlerSelect);

        // Show/hide fielder based on dismissal type
        document.getElementById('dismissal-type')?.addEventListener('change', (e) => {
            const fielderGroup = document.getElementById('fielder-group');
            if (['catch', 'stump-out', 'run-out'].includes(e.target.value)) {
                fielderGroup.style.display = 'block';
            } else {
                fielderGroup.style.display = 'none';
            }
        });

        // Load match on page load
        loadMatch();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

